  SELECT  	periodos.p AS percentil, 	periodos.ind_grupo, 	periodos.cod_peri, 	periodos.val_nomb_peri, 	datos.AVG, 	datos.monto_venta, 	datos.cant_sol, 	por_apor_per AS desacumulado FROM  	( 	SELECT  		cod_peri, 		oid_peri, 		SUM(monto_venta) AS monto_venta, 		AVG(monto_venta)AS AVG, 		DECODE(monto_venta_per,0,0,SUM(monto_venta)  * 100 /monto_venta_per)AS por_apor_per, 		percentil, 		COUNT(oid_soli_cabe)cant_sol    	FROM  		( 		SELECT 			datos.cod_peri, 			datos.oid_peri, 			datos.val_nomb_peri, 			datos.monto_venta, 			datos.oid_soli_cabe, 			MIN(tabla_percentiles.p)AS percentil, 			datos.monto_venta_per 		FROM  			( 			SELECT 				oid_soli_cabe, 				cod_peri, 				SUM(monto_venta)AS monto_venta, 				SUM(SUM(monto_venta)) OVER (PARTITION BY cod_peri ORDER BY 1) monto_venta_per, 				ROW_NUMBER() OVER (PARTITION BY cod_peri ORDER BY NVL(SUM(monto_venta),0) DESC) * 100 / 					COUNT(oid_soli_cabe) OVER (PARTITION BY cod_peri ORDER BY 1) AS percentil, 				val_nomb_peri, 				oid_peri 			FROM 				( 				SELECT  					sol.oid_soli_cabe, 					per.val_nomb_peri, 					per.oid_peri, 					cor.COD_PERI, 					pos.OID_SOLI_POSI, 					sol.VAL_TIPO_CAMB, 					sol.fec_fact, 					( 					CASE 						WHEN pla_con.TVEN_OID_TIPO_VENT = 3 THEN  							NVL(pos.NUM_UNID_COMPR,0) * NVL(pos.VAL_PREC_CATA_UNIT_DOCU,0) 						WHEN pla_con.TVEN_OID_TIPO_VENT = 1 THEN  							(NVL(pos.NUM_UNID_COMPR,0) * NVL(pos.VAL_PREC_CATA_UNIT_DOCU,0)) 							- (NVL(pos.VAL_IMPO_DESC_UNIT_DOCU,0) * NVL(pos.NUM_UNID_COMPR,0)) 							- (NVL(pos.VAL_IMPO_IMPU_UNIT_DOCU,0) * NVL(pos.NUM_UNID_COMPR,0)) 						WHEN pla_con.TVEN_OID_TIPO_VENT = 2 THEN 							  	   			  							(NVL(pos.NUM_UNID_COMPR,0) * NVL(pos.VAL_PREC_CATA_UNIT_DOCU,0)) 							- (NVL(pos.VAL_IMPO_DESC_UNIT_DOCU,0) * NVL(pos.NUM_UNID_COMPR,0)) 					END 					) * DECODE( NVL(sol.val_tipo_camb,0),0,1,sol.val_tipo_camb ) 					* DECODE( pais.mone_oid_mone, 2 ,  						1, 						( 						SELECT tip_cam.VAL_TIPO_CAMB 						FROM seg_tipo_cambi tip_cam 						WHERE pais.MONE_OID_MONE = tip_cam.MONE_OID_MON1 						AND tip_cam.MONE_OID_MON2 =  2  						AND sol.FEC_FACT BETWEEN tip_cam.FEC_DESD AND tip_cam.FEC_HAST 						) 					) AS monto_venta 				FROM  					ped_solic_cabec sol, 					ped_solic_posic pos, 					cra_perio per, 					inc_concu_param_gener con, 					inc_plant_concu pla_con, 					zon_zona zon, 					zon_regio reg, 					pre_ofert_detal of_det, 					mae_produ prod, 					mae_clien_tipo_subti subt, 					mae_clien_clasi cla, 					seg_perio_corpo cor, 					seg_pais pais 				WHERE 					sol.OID_SOLI_CABE = pos.soca_oid_soli_cabe 					AND sol.pais_oid_pais =  1  					AND sol.PERD_OID_PERI = per.oid_peri 					AND per.marc_oid_marc =  1   					AND per.cana_oid_cana =  1   					  AND sol.ZZON_OID_ZONA IN  ( 1 )  					AND sol.ZZON_OID_ZONA = zon.OID_ZONA 					AND zon.ZORG_OID_REGI = reg.OID_REGI 					AND sol.IND_OC = 1 					 AND reg.OID_REGI IN ( 1 )   					AND reg.ZSGV_OID_SUBG_VENT IN  ( 1 )  					AND pos.OFDE_OID_DETA_OFER = of_det.OID_DETA_OFER 					  AND of_det.TOFE_OID_TIPO_OFER NOT IN  ( 1 )   					AND pos.prod_oid_prod = prod.oid_prod 					   AND prod.UNEG_OID_UNID_NEGO IN  ( 1 )   					   AND prod.NEGO_OID_NEGO IN  ( 1 )   					AND per.PERI_OID_PERI = cor.OID_PERI 					AND cor.VAL_ANIO =  '2004'  	 					AND sol.pais_oid_pais = pais.OID_PAIS 					AND subt.clie_oid_clie = sol.clie_oid_clie 					AND subt.oid_clie_tipo_subt = cla.CTSU_OID_CLIE_TIPO_SUBT 					AND subt.ind_ppal = 1 					AND cla.ind_ppal = 1 					  	AND subt.SBTI_OID_SUBT_CLIE  IN ( 1 )   					  	 AND subt.ticl_oid_tipo_clie IN   ( 1 )   					  	 AND cla.CLAS_OID_CLAS IN   ( 1 )   					  	  AND cla.TCCL_OID_TIPO_CLASI IN   ( 1 )   					AND sol.COPA_OID_PARA_GENE = con.OID_PARA_GRAL 					AND con.PLC2_OID_PLAN_CONC = pla_con.OID_PLAN_CONC 					AND pla_con.TVEN_OID_TIPO_VENT =   1  				) 			GROUP BY  				oid_soli_cabe, 				val_tipo_camb, 				val_nomb_peri, 				oid_peri, 				cod_peri, 				fec_fact 			) datos, 			( 			SELECT * 			FROM  				( 					SELECT	0.1 p FROM dual UNION SELECT	0.2	FROM dual UNION SELECT	0.3	FROM dual UNION 					SELECT	0.4	FROM dual UNION SELECT	0.5	FROM dual UNION SELECT	0.6	FROM dual UNION 					SELECT	0.7	FROM dual UNION SELECT	0.8	FROM dual UNION SELECT	0.9	FROM dual UNION 					SELECT	1 	FROM dual UNION SELECT	2	FROM dual UNION SELECT	3	FROM dual UNION 					SELECT	4	FROM dual UNION SELECT	5	FROM dual UNION SELECT	6	FROM dual UNION 					SELECT	7	FROM dual UNION SELECT	8	FROM dual UNION SELECT	9	FROM dual UNION 					SELECT	10	FROM dual UNION SELECT	11	FROM dual UNION SELECT	12	FROM dual UNION 					SELECT	13	FROM dual UNION SELECT	14	FROM dual UNION SELECT	15	FROM dual UNION 					SELECT	16	FROM dual UNION SELECT	17	FROM dual UNION SELECT	18	FROM dual UNION 					SELECT	19	FROM dual UNION SELECT	20	FROM dual UNION SELECT	21	FROM dual UNION 					SELECT	22	FROM dual UNION SELECT	23	FROM dual UNION SELECT	24	FROM dual UNION 					SELECT	25	FROM dual UNION SELECT	26	FROM dual UNION SELECT	27	FROM dual UNION 					SELECT	28	FROM dual UNION SELECT	29	FROM dual UNION SELECT	30	FROM dual UNION 					SELECT	31	FROM dual UNION SELECT	32	FROM dual UNION SELECT	33	FROM dual UNION 					SELECT	34	FROM dual UNION SELECT	35	FROM dual UNION SELECT	36	FROM dual UNION 					SELECT	37	FROM dual UNION SELECT	38	FROM dual UNION SELECT	39	FROM dual UNION 					SELECT	40	FROM dual UNION SELECT	41	FROM dual UNION SELECT	42	FROM dual UNION 					SELECT	43	FROM dual UNION SELECT	44	FROM dual UNION SELECT	45	FROM dual UNION 					SELECT	46	FROM dual UNION SELECT	47	FROM dual UNION SELECT	48	FROM dual UNION 					SELECT	49	FROM dual UNION SELECT	50	FROM dual UNION SELECT	51	FROM dual UNION 					SELECT	52	FROM dual UNION SELECT	53	FROM dual UNION SELECT	54	FROM dual UNION 					SELECT	55	FROM dual UNION SELECT	56	FROM dual UNION SELECT	57	FROM dual UNION 					SELECT	58	FROM dual UNION SELECT	59	FROM dual UNION SELECT	60	FROM dual UNION 					SELECT	61	FROM dual UNION SELECT	62	FROM dual UNION SELECT	63	FROM dual UNION 					SELECT	64	FROM dual UNION SELECT	65	FROM dual UNION SELECT	66	FROM dual UNION 					SELECT	67	FROM dual UNION SELECT	68	FROM dual UNION SELECT	69	FROM dual UNION 					SELECT	70	FROM dual UNION SELECT	71	FROM dual UNION SELECT	72	FROM dual UNION 					SELECT	73	FROM dual UNION SELECT	74	FROM dual UNION SELECT	75	FROM dual UNION 					SELECT	76	FROM dual UNION SELECT	77	FROM dual UNION SELECT	78	FROM dual UNION 					SELECT	79	FROM dual UNION SELECT	80	FROM dual UNION SELECT	81	FROM dual UNION 					SELECT	82	FROM dual UNION SELECT	83	FROM dual UNION SELECT	84	FROM dual UNION 					SELECT	85	FROM dual UNION SELECT	86	FROM dual UNION SELECT	87	FROM dual UNION 					SELECT	88	FROM dual UNION SELECT	89	FROM dual UNION SELECT	90	FROM dual UNION 					SELECT	91	FROM dual UNION SELECT	92	FROM dual UNION SELECT	93	FROM dual UNION 					SELECT	94	FROM dual UNION SELECT	95	FROM dual UNION SELECT	96	FROM dual UNION 					SELECT	97	FROM dual UNION SELECT	98	FROM dual UNION SELECT	99	FROM dual UNION 					SELECT	100	FROM dual 				) 			WHERE p IN ( 0.2,0.3,0.4,0.5,0.9,1,2,3,4,34,67,100 )  			) tabla_percentiles 		WHERE datos.percentil  < = tabla_percentiles.p 		GROUP BY 			datos.cod_peri, 			datos.oid_peri, 			datos.val_nomb_peri, 			datos.monto_venta, 			datos.monto_venta_per, 			oid_soli_cabe 		) 	GROUP BY 		cod_peri, 		oid_peri, 		percentil, 		monto_venta_per 	)datos, 	( 	SELECT 		tabla_percentiles.*, 		periodos.* 	FROM 		( 		SELECT * 		FROM  			( 				SELECT	0.1 p FROM dual UNION SELECT	0.2	FROM dual UNION SELECT	0.3	FROM dual UNION 				SELECT	0.4	FROM dual UNION SELECT	0.5	FROM dual UNION SELECT	0.6	FROM dual UNION 				SELECT	0.7	FROM dual UNION SELECT	0.8	FROM dual UNION SELECT	0.9	FROM dual UNION 				SELECT	1 	FROM dual UNION SELECT	2	FROM dual UNION SELECT	3	FROM dual UNION 				SELECT	4	FROM dual UNION SELECT	5	FROM dual UNION SELECT	6	FROM dual UNION 				SELECT	7	FROM dual UNION SELECT	8	FROM dual UNION SELECT	9	FROM dual UNION 				SELECT	10	FROM dual UNION SELECT	11	FROM dual UNION SELECT	12	FROM dual UNION 				SELECT	13	FROM dual UNION SELECT	14	FROM dual UNION SELECT	15	FROM dual UNION 				SELECT	16	FROM dual UNION SELECT	17	FROM dual UNION SELECT	18	FROM dual UNION 				SELECT	19	FROM dual UNION SELECT	20	FROM dual UNION SELECT	21	FROM dual UNION 				SELECT	22	FROM dual UNION SELECT	23	FROM dual UNION SELECT	24	FROM dual UNION 				SELECT	25	FROM dual UNION SELECT	26	FROM dual UNION SELECT	27	FROM dual UNION 				SELECT	28	FROM dual UNION SELECT	29	FROM dual UNION SELECT	30	FROM dual UNION 				SELECT	31	FROM dual UNION SELECT	32	FROM dual UNION SELECT	33	FROM dual UNION 				SELECT	34	FROM dual UNION SELECT	35	FROM dual UNION SELECT	36	FROM dual UNION 				SELECT	37	FROM dual UNION SELECT	38	FROM dual UNION SELECT	39	FROM dual UNION 				SELECT	40	FROM dual UNION SELECT	41	FROM dual UNION SELECT	42	FROM dual UNION 				SELECT	43	FROM dual UNION SELECT	44	FROM dual UNION SELECT	45	FROM dual UNION 				SELECT	46	FROM dual UNION SELECT	47	FROM dual UNION SELECT	48	FROM dual UNION 				SELECT	49	FROM dual UNION SELECT	50	FROM dual UNION SELECT	51	FROM dual UNION 				SELECT	52	FROM dual UNION SELECT	53	FROM dual UNION SELECT	54	FROM dual UNION 				SELECT	55	FROM dual UNION SELECT	56	FROM dual UNION SELECT	57	FROM dual UNION 				SELECT	58	FROM dual UNION SELECT	59	FROM dual UNION SELECT	60	FROM dual UNION 				SELECT	61	FROM dual UNION SELECT	62	FROM dual UNION SELECT	63	FROM dual UNION 				SELECT	64	FROM dual UNION SELECT	65	FROM dual UNION SELECT	66	FROM dual UNION 				SELECT	67	FROM dual UNION SELECT	68	FROM dual UNION SELECT	69	FROM dual UNION 				SELECT	70	FROM dual UNION SELECT	71	FROM dual UNION SELECT	72	FROM dual UNION 				SELECT	73	FROM dual UNION SELECT	74	FROM dual UNION SELECT	75	FROM dual UNION 				SELECT	76	FROM dual UNION SELECT	77	FROM dual UNION SELECT	78	FROM dual UNION 				SELECT	79	FROM dual UNION SELECT	80	FROM dual UNION SELECT	81	FROM dual UNION 				SELECT	82	FROM dual UNION SELECT	83	FROM dual UNION SELECT	84	FROM dual UNION 				SELECT	85	FROM dual UNION SELECT	86	FROM dual UNION SELECT	87	FROM dual UNION 				SELECT	88	FROM dual UNION SELECT	89	FROM dual UNION SELECT	90	FROM dual UNION 				SELECT	91	FROM dual UNION SELECT	92	FROM dual UNION SELECT	93	FROM dual UNION 				SELECT	94	FROM dual UNION SELECT	95	FROM dual UNION SELECT	96	FROM dual UNION 				SELECT	97	FROM dual UNION SELECT	98	FROM dual UNION SELECT	99	FROM dual UNION 				SELECT	100	FROM dual 			) 		WHERE p IN  ( 0.2,0.3,0.4,0.5,0.9,1,2,3,4,34,67,100 )  		) tabla_percentiles, 		(				 		SELECT 			per.val_nomb_peri, 			per.OID_PERI, 			cod_peri, 			SUBSTR(cor.cod_peri,5,2)AS cod_per, 			TRUNC((SUBSTR(cor.cod_peri,5,2) - 1 )/6 +1)AS ind_grupo				    		FROM 			cra_perio per, 			seg_perio_corpo cor 		WHERE 			per.peri_oid_peri = cor.OID_PERI 			AND cor.VAL_ANIO =  '2004'   			 			AND per.pais_oid_pais =  1   			 			AND per.marc_oid_marc =   1  			 			AND per.cana_oid_cana =  1  		) periodos 	) periodos WHERE 	datos.oid_peri(+) = periodos.oid_peri  	AND datos.percentil(+) = periodos.p ORDER BY 	PERCENTIL, 	COD_PERI 